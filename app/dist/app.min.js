!function(){"use strict";var t=function(){function t(t,n,s){var r=this;void 0===s&&(s=0),this.print=function(){return console.table(r.data)},this.rows=t,this.columns=n,this.data=new Array(this.rows).fill(0).map((function(){return new Array(r.columns).fill(s)}))}return t.fromArray=function(n){for(var s=n.length,r=n[0].length||1,a=new t(s,r),i=0;i<s;i++)for(var e=0;e<r;e++)a.data[i][e]=1===r?n[i]:n[i][e];return a},t.toFlatArray=function(t){for(var n=[],s=0;s<t.rows;s++)for(var r=0;r<t.columns;r++)n.push(t.data[s][r]);return n},t.prototype.randomise=function(){this.data=this.data.map((function(t){return t.map((function(){return 2*Math.random()-1}))}))},t.prototype.scale=function(t){this.data=this.data.map((function(n){return n.map((function(n){return n*t}))}))},t.prototype.add=function(n){this.data=this.data.map((function(s,r){return s.map((function(s,a){return s+(n instanceof t?n.data[r][a]:n)}))}))},t.prototype.subtract=function(t){this.data=this.data.map((function(n,s){return n.map((function(n,r){return n-("number"==typeof t?t:t.data[s][r])}))}))},t.subtract=function(n,s){if(n.rows===s.rows||n.columns===s.rows){for(var r=new t(n.rows,n.columns),a=0;a<r.rows;a++)for(var i=0;i<r.columns;i++)r.data[a][i]=n.data[a][i]-s.data[a][i];return r}console.error("columns must match columns")},t.multiply=function(n,s){if(n.columns===s.rows){for(var r=new t(n.rows,s.columns),a=0;a<r.rows;a++)for(var i=0;i<r.columns;i++){for(var e=0,o=0;o<n.columns;o++)e+=n.data[a][o]*s.data[o][i];r.data[a][i]=e}return r}console.error("columns must match columns")},t.prototype.multiply=function(t){for(var n=0;n<this.rows;n++)for(var s=0;s<this.columns;s++)this.data[n][s]*=t.data[n][s]},t.map=function(n,s){var r=new t(n.rows,n.columns);return r.data=n.data.map((function(t){return t.map((function(t){return s(t)}))})),r},t.prototype.map=function(t){this.data=this.data.map((function(n){return n.map((function(n){return t(n)}))}))},t.transpose=function(n){for(var s=new t(n.columns,n.rows),r=0;r<n.rows;r++)for(var a=0;a<n.columns;a++)s.data[a][r]=n.data[r][a];return s},t.prototype.transpose=function(){for(var n=new t(this.columns,this.rows),s=0;s<this.rows;s++)for(var r=0;r<this.columns;r++)n.data[r][s]=this.data[s][r];return n},t.prototype.copy=function(){for(var n=new t(this.rows,this.columns),s=0;s<this.rows;s++)for(var r=0;r<this.columns;r++)n.data[s][r]=this.data[s][r];return n},t}(),n=function(t){return 1/(1+Math.exp(-t))},s=function(t){return t*(1-t)},r=function(){function r(n,s,r){this.hiddenLayers=[],this.weights=[],this.biases=[],this.inputs=n,this.hiddenLayerCount=s.length,this.outputs=r,this.learningRate=.2,this.weights.push(new t(s[0],n)),this.weights[0].randomise();for(var a=0;a<s.length;a++)a+1<s.length&&(this.weights.push(new t(s[a+1],s[a])),this.weights[a+1].randomise()),this.biases.push(new t(s[a],1)),this.biases[a].randomise();this.weights.push(new t(r,s[s.length-1])),this.weights[this.weights.length-1].randomise(),this.biases.push(new t(r,1)),this.biases[this.biases.length-1].randomise(),this.weights_ho=new t(r,s[s.length-1]),this.weights_ho.randomise(),this.bias_o=new t(r,1),this.bias_o.randomise()}return r.prototype.trainMultiLevel=function(n,r){var a=this.feedForwardArray(n),i=t.fromArray(n),e=t.fromArray(a),o=t.fromArray(r),h=t.subtract(o,e),u=t.map(this.generatedOutputs,s);u.multiply(h),u.scale(this.learningRate);var d=t.transpose(this.hiddenLayers[this.hiddenLayers.length-1]),l=t.multiply(u,d);this.weights[this.weights.length-1].add(l),this.biases[this.biases.length-1].add(u);for(var c=h,f=null,p=this.hiddenLayers.length-1;p>-1;p--){var m=t.transpose(this.weights[p+1]);c=t.multiply(m,c),(f=t.map(this.hiddenLayers[p],s)).multiply(c),f.scale(this.learningRate);var g=t.transpose(p>=1?this.hiddenLayers[p-1]:i),w=t.multiply(f,g);this.weights[p].add(w),this.biases[p].add(f)}},r.prototype.feedForwardArray=function(s){for(var r=t.fromArray(s),a=0;a<this.hiddenLayerCount;a++)this.hiddenLayers[a]=t.multiply(this.weights[a],0===a?r:this.hiddenLayers[a-1]),this.hiddenLayers[a].add(this.biases[a]),this.hiddenLayers[a].map(n);return this.generatedOutputs=t.multiply(this.weights[this.weights.length-1],this.hiddenLayers[this.hiddenLayerCount-1]),this.generatedOutputs.add(this.biases[this.biases.length-1]),this.generatedOutputs.map(n),t.toFlatArray(this.generatedOutputs)},r}(),a=document.getElementById("p5-container");new p5((function(t){var n,s,a,i,e={training:[],testing:[]},o={training:[],testing:[]},h={training:[],testing:[]};function u(t,n,s){console.log(),t.training=[],t.testing=[];for(var r=1e5,a=0;a<r;a++){var i=784*a,e=Math.floor(8e4);a<e?(t.training[a]=n.bytes.subarray(i,i+784),t.training[a].label=s):(t.testing[a-e]=n.bytes.subarray(i,i+784),t.training[a-e].label=s)}}t.preload=function(){n=t.loadBytes("./data/cats.bin"),s=t.loadBytes("./data/cars.bin"),a=t.loadBytes("./data/carrots.bin")},t.setup=function(){u(e,n,0),u(o,s,1),u(h,a,2),i=new r(784,[786],3);var d=[];d=(d=(d=d.concat(e.training)).concat(o.training)).concat(h.training),t.shuffle(d,!0);for(var l=0,c=1e3,f=0;f<c;f++){f/c*100>l+1&&(console.clear(),console.log(f/c*100+"%"),l=f/c*100);for(var p=[],m=d[f],g=0;g<m.length;g++)p[g]=m[g]/255;var w=[0,0,0];w[d[f].label]=1,i.trainMultiLevel(p,w)}console.log(i.feedForwardArray(e.testing[0]))}}),a)}();
